<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <title>MTF Snapshotter ‚Äî Mobile</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MTF Snapshotter">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0f14"/>
  <style>
    :root {
      --bg: #0b0f14; --panel: #121821; --text: #e5eef7; --muted: #99a8b8;
      --accent: #4fc3f7; --border: #243040;
    }
    html, body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial; }
    .wrap { max-width: 720px; margin: 0 auto; padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom); }
    h1 { font-size: 18px; margin: 8px 0 12px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 14px; }
    label { font-size: 12px; color: var(--muted); }
    input[type="text"] { width: 100%; background: #0e141b; color: var(--text); border: 1px solid var(--border); border-radius: 12px; padding: 12px 14px; font-size: 16px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:8px 0; }
    .btn { flex:1; background: #132034; color: var(--text); border: 1px solid var(--border); padding: 12px; border-radius: 12px; font-size: 16px; }
    .btn.primary { background: var(--accent); color: #032130; border: none; }
    .btn:active { transform: translateY(1px); }
    .pill { display:inline-block; background:#0f1927; border:1px solid var(--border); padding:4px 8px; border-radius:999px; color:var(--muted); font-size:12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 12px; }
    th, td { border-bottom: 1px dashed var(--border); padding: 6px; text-align: left; }
    th { color: var(--muted); text-transform: uppercase; font-size: 11px; letter-spacing: .06em; }
    td.right { text-align: right; }
    .src { font-size: 11px; color: var(--muted); }
    .divider { height:1px; background:var(--border); margin:10px 0 0; }
    .notice { font-size: 12px; color: var(--muted); margin-top: 10px; }
    .toast { position: fixed; bottom: calc(env(safe-area-inset-bottom) + 12px); left: 50%; transform: translateX(-50%);
             background: #182a44; color: #e5eef7; padding: 10px 14px; border-radius: 999px; font-size: 14px; display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üì± MTF Snapshotter ‚Äî Mobile</h1>
    <div class="card">
      <label>C·∫∑p (CSV)</label>
      <input id="symbols" type="text" value="BTCUSDT,ETHUSDT" inputmode="latin" autocomplete="off" autocapitalize="characters"/>
      <div class="row">
        <label><input type="checkbox" id="tf1h" checked> 1h</label>
        <label><input type="checkbox" id="tf4h" checked> 4h</label>
        <label><input type="checkbox" id="tfd1" checked> 1d</label>
      </div>
      <div class="row">
        <button class="btn primary" id="fetchBtn">Fetch & Compute</button>
        <button class="btn" id="copyBtn">Copy Snapshot</button>
        <button class="btn" id="installBtn" style="display:none;">Add to Home</button>
      </div>
      <div id="status" class="src" style="margin-top:6px;"></div>
    </div>

    <div id="output" style="margin-top:12px;"></div>
    <div class="notice">Tip: Th√™m v√†o M√†n h√¨nh ch√≠nh ƒë·ªÉ d√πng nh∆∞ app. D·ªØ li·ªáu OHLC ∆∞u ti√™n: Binance ‚Üí OKX ‚Üí Bybit. Ch·ªâ d√πng n·∫øn ƒë√≥ng.</div>
  </div>

  <div id="toast" class="toast">ƒê√£ copy snapshot!</div>

<script>
if('serviceWorker' in navigator){
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
// PWA install prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById('installBtn');
  btn.style.display = 'inline-block';
  btn.onclick = async () => {
    btn.style.display = 'none';
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
  };
});

const API = {
  binance: (sym, tf, lim=500) => `https://api.binance.com/api/v3/klines?symbol=${sym}&interval=${tf}&limit=${lim}`,
  okx: (sym, tf, lim=500) => {
    const inst = sym.replace("USDT","-USDT");
    const bar = ({'1h':'1H','4h':'4H','1d':'1D'})[tf];
    return `https://www.okx.com/api/v5/market/candles?instId=${inst}&bar=${bar}&limit=${lim}`;
  },
  bybit: (sym, tf, lim=500) => {
    const ival = ({'1h':'60','4h':'240','1d':'D'})[tf];
    return `https://api.bybit.com/v5/market/kline?category=spot&symbol=${sym}&interval=${ival}&limit=${lim}`;
  }
};

function fmt(n, d=2){ if(n==null || isNaN(n)) return "‚Äî"; return Number(n).toFixed(d); }
function tzVN(ts){ return new Date((ts)*1000 + 7*3600*1000).toISOString().replace('T',' ').slice(0,16); }

async function fetchKlines(sym, tf, lim=500){
  // Binance
  try {
    const r = await fetch(API.binance(sym, tf, lim), {cache:'no-store'});
    if(r.ok){
      const arr = await r.json();
      const rows = arr.map(a => ({
        ts: Math.floor(a[6]/1000),
        open: +a[1], high: +a[2], low: +a[3], close: +a[4], volume: +a[5],
        src: 'Binance'
      }));
      return rows;
    }
  } catch(e){}
  // OKX
  try {
    const r = await fetch(API.okx(sym, tf, lim), {cache:'no-store'});
    if(r.ok){
      const js = await r.json();
      const data = js.data || [];
      if(data.length){
        const rows = data.map(row => ({
          ts: Math.floor(+row[0]/1000),
          open: +row[1], high: +row[2], low: +row[3], close: +row[4], volume: +row[5],
          src: 'OKX'
        })).sort((a,b)=>a.ts-b.ts);
        return rows;
      }
    }
  } catch(e){}
  // Bybit
  try {
    const r = await fetch(API.bybit(sym, tf, lim), {cache:'no-store'});
    if(r.ok){
      const js = await r.json();
      const list = (js.result && js.result.list) || [];
      if(list.length){
        const rows = list.map(row => ({
          ts: Math.floor(+row[1]/1000),
          open: +row[2], high: +row[3], low: +row[4], close: +row[5], volume: +row[6],
          src: 'Bybit'
        })).sort((a,b)=>a.ts-b.ts);
        return rows;
      }
    }
  } catch(e){}
  throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c OHLC t·ª´ Binance/OKX/Bybit (ki·ªÉm tra m·∫°ng ho·∫∑c CORS).");
}

// Indicators (lightweight)
function ema(arr, p){ const k=2/(p+1); let out=[], prev=arr[0]; out.push(prev); for(let i=1;i<arr.length;i++){ const v=arr[i]*k + prev*(1-k); out.push(v); prev=v; } return out; }
function sma(arr,p){ let out=[],sum=0; for(let i=0;i<arr.length;i++){ sum+=arr[i]; if(i>=p) sum-=arr[i-p]; out.push(i>=p-1? sum/p : NaN); } return out; }
function rsi(close,p=14){ let g=[],l=[]; for(let i=1;i<close.length;i++){ const d=close[i]-close[i-1]; g.push(Math.max(0,d)); l.push(Math.max(0,-d)); } const ag=sma(g,p), al=sma(l,p); let out=[NaN]; for(let i=0;i<ag.length;i++){ if(i<p-1){out.push(NaN);continue;} const rs=(al[i]===0)?100:ag[i]/al[i]; out.push(100-(100/(1+rs))); } return out; }
function macd(close, f=12, s=26, sig=9){ const ef=ema(close,f), es=ema(close,s); const line=ef.map((v,i)=>v-es[i]); const sigArr=ema(line.slice(s-1),sig); const sigFull=Array(s-1).fill(NaN).concat(sigArr); const hist=line.map((v,i)=>v-(sigFull[i]??NaN)); return {line, signal:sigFull, hist}; }
function atr(h,l,c,p=14){ let tr=[NaN]; for(let i=1;i<c.length;i++){ const pc=c[i-1]; tr.push(Math.max(h[i]-l[i], Math.abs(h[i]-pc), Math.abs(l[i]-pc))); } return sma(tr,p); }
function bb(close,p=20,n=2){ const ma=sma(close,p); let sd=[]; for(let i=0;i<close.length;i++){ if(i<p-1){sd.push(NaN);continue;} const w=close.slice(i-p+1,i+1); const m=ma[i]; const v=w.reduce((a,v)=>a+Math.pow(v-m,2),0)/p; sd.push(Math.sqrt(v)); } const up=ma.map((m,i)=>isNaN(m)||isNaN(sd[i])?NaN:m+n*sd[i]); const lo=ma.map((m,i)=>isNaN(m)||isNaN(sd[i])?NaN:m-n*sd[i]); const width=ma.map((m,i)=>isNaN(m)||m===0||isNaN(sd[i])?NaN:(up[i]-lo[i])/m); return {ma,up,lo,width}; }

function lastClosedIndex(rows, tf){
  const now = Date.now()/1000;
  const dur = {'1h':3600,'4h':14400,'1d':86400}[tf];
  let i = rows.length-1;
  if(now - rows[i].ts < 0.5*dur){ i -= 1; }
  return i;
}

function analyzeTF(rows, tf){
  const i = lastClosedIndex(rows, tf);
  if(i<50) throw new Error("D·ªØ li·ªáu ch∆∞a ƒë·ªß ƒë·ªÉ t√≠nh ·ªïn ƒë·ªãnh.");
  const cut = rows.slice(0,i+1);
  const ts=cut.map(r=>r.ts), close=cut.map(r=>r.close), high=cut.map(r=>r.high), low=cut.map(r=>r.low), vol=cut.map(r=>r.volume);
  const ema10=ema(close,10), ema20=ema(close,20), ema50=ema(close,50);
  const rsi14=rsi(close,14); const m=macd(close,12,26,9);
  const atr14=atr(high,low,close,14); const b=bb(close,20,2); const vol20=sma(vol,20);
  const k=cut.length-1;
  return {
    ts: ts[k], close: close[k], ema10: ema10[k], ema20: ema20[k], ema50: ema50[k],
    rsi14: rsi14[k], macd: m.line[k], macd_signal: m.signal[k], macd_hist: m.hist[k],
    atr14: atr14[k], bb_width: b.width[k], vol20: vol20[k], source: cut[cut.length-1].src
  };
}

function trendSignal(s){
  let b=0, r=0;
  if(s.close > s.ema20 && s.close > s.ema50) b++; else r++;
  if(s.ema10 > s.ema20 && s.ema20 > s.ema50) b++; else if(s.ema10 < s.ema20 && s.ema20 < s.ema50) r++;
  if(s.rsi14 > 50) b++; else if(s.rsi14 < 50) r++;
  if(s.macd >= s.macd_signal) b++; else r++;
  if(b>=3 && r<=1) return 'Bullish';
  if(r>=3 && b<=1) return 'Bearish';
  return 'Mixed';
}

function renderCard(sym, states){
  const out = document.getElementById('output');
  const d1=states['1d'], h4=states['4h'], h1=states['1h'];
  const votes = [d1&&trendSignal(d1), h4&&trendSignal(h4), h1&&trendSignal(h1)];
  const longVotes = votes.filter(v=>v==='Bullish').length;
  const shortVotes = votes.filter(v=>v==='Bearish').length;
  const pill = `Long ${longVotes}/3 vs Short ${shortVotes}/3`;
  const srcPill = ['1d','4h','1h'].map(tf=> states[tf]? `${tf.toUpperCase()}:${states[tf].source}`:'').filter(Boolean).join(' ¬∑ ') || '‚Äî';

  function row(tf, s){
    if(!s) return `<tr><td>${tf}</td><td colspan="7">Thi·∫øu d·ªØ li·ªáu</td><td>‚Äî</td><td>‚Äî</td></tr>`;
    return `<tr>
      <td>${tf.toUpperCase()}</td>
      <td class="right">${fmt(s.close,2)}</td>
      <td class="right">${fmt(s.ema10,2)}</td>
      <td class="right">${fmt(s.ema20,2)}</td>
      <td class="right">${fmt(s.ema50,2)}</td>
      <td class="right">${fmt(s.rsi14,2)}</td>
      <td class="right">${fmt(s.macd,2)}</td>
      <td class="right">${fmt(s.atr14,2)}</td>
      <td>${tzVN(s.ts)}</td>
      <td class="src">${s.source}</td>
    </tr>`;
  }

  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;">
      <div><strong>${sym}</strong> ¬∑ <span class="pill">${pill}</span></div>
      <div class="pill">Ngu·ªìn: ${srcPill}</div>
    </div>
    <table>
      <thead><tr>
        <th>Khung</th><th class="right">Close</th><th class="right">EMA10</th><th class="right">EMA20</th><th class="right">EMA50</th>
        <th class="right">RSI14</th><th class="right">MACD</th><th class="right">ATR14</th><th>N·∫øn (VN)</th><th>Ngu·ªìn</th>
      </tr></thead>
      <tbody>
        ${row('D1', d1)}
        ${row('H4', h4)}
        ${row('H1', h1)}
      </tbody>
    </table>
  `;
  out.appendChild(card);
}

function toast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.display='block';
  setTimeout(()=> t.style.display='none', 1600);
}

async function run(){
  const status = document.getElementById('status');
  status.textContent = 'ƒêang t·∫£i OHLC...';
  const syms = document.getElementById('symbols').value.split(',').map(s=>s.trim().toUpperCase()).filter(Boolean);
  const tfs=[]; if(document.getElementById('tf1h').checked) tfs.push('1h'); if(document.getElementById('tf4h').checked) tfs.push('4h'); if(document.getElementById('tfd1').checked) tfs.push('1d');
  const output = document.getElementById('output'); output.innerHTML='';

  for(const sym of syms){
    const states = {};
    for(const tf of tfs){
      try {
        const rows = await fetchKlines(sym, tf, 500);
        const st = analyzeTF(rows, tf);
        states[tf] = st;
      } catch(e){
        const card = document.createElement('div');
        card.className='card';
        card.innerHTML = `<div style="color:#ffcc80;">${sym} ${tf.toUpperCase()}: ${e.message}</div>`;
        output.appendChild(card);
      }
    }
    if(Object.keys(states).length) renderCard(sym, states);
  }
  status.textContent = 'Ho√†n t·∫•t.';
}

function copySnapshot(){
  const cards = document.querySelectorAll('#output .card');
  if(!cards.length){ toast('Ch∆∞a c√≥ d·ªØ li·ªáu'); return; }
  let md = `# SNAPSHOT MTF (VN) ‚Äî ${new Date().toLocaleTimeString('vi-VN')} ${new Date().toLocaleDateString('vi-VN')}\n\n`;
  cards.forEach(card=>{
    const head = card.querySelector('div strong').textContent.trim();
    const pills = [...card.querySelectorAll('.pill')].map(p=>p.textContent.trim()).join(' | ');
    md += `## ${head}\n${pills}\n\n`;
    const rows = [...card.querySelectorAll('tbody tr')].map(tr=> [...tr.querySelectorAll('td')].map(td=> td.textContent.trim()));
    md += `| Khung | Close | EMA10 | EMA20 | EMA50 | RSI14 | MACD | ATR14 | N·∫øn (VN) | Ngu·ªìn |\n|---|---:|---:|---:|---:|---:|---:|---:|---|---|\n`;
    rows.forEach(r=>{ if(r.length===10){ md += `| ${r[0]} | ${r[1]} | ${r[2]} | ${r[3]} | ${r[4]} | ${r[5]} | ${r[6]} | ${r[7]} | ${r[8]} | ${r[9]} |\n`; } });
    md += `\n`;
  });
  navigator.clipboard.writeText(md).then(()=> toast('ƒê√£ copy snapshot!'), ()=> toast('Copy th·∫•t b·∫°i'));
}

document.getElementById('fetchBtn').addEventListener('click', run);
document.getElementById('copyBtn').addEventListener('click', copySnapshot);
</script>
</body>
</html>
