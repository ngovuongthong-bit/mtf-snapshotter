<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>OMEGA LITE+ ‚Äî Liquidity ‚Ä¢ Trap ‚Ä¢ OCR Winrate (VN)</title>
<meta name="theme-color" content="#0b0f14"/>
<link rel="manifest" href="./manifest.webmanifest">
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
<style>
:root{--bg:#0b0f14;--panel:#0f1824;--text:#e7f0fb;--muted:#9fb0c6;--accent:#4fc3f7;--border:#203043;--ok:#00c853;--warn:#ffab00;--bad:#ff5252}
*{box-sizing:border-box}
html,body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1300px;margin:20px auto;padding:0 14px}
h1{font-size:20px;margin:0 0 10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
h2{font-size:15px;margin:14px 0 8px;color:var(--accent)}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-top:10px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{background:#132034;color:#e7f0fb;border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn:hover{background:#182a44}
.btn.primary{background:var(--accent);color:#072338;border:none}
input,select,textarea{background:#0d141c;color:#e7f0fb;border:1px solid var(--border);border-radius:10px;padding:8px 10px}
.small{font-size:12px;color:#9fb0c6}
.chart{width:100%;height:220px;border-radius:12px;border:1px solid var(--border);margin-top:6px}
table{width:100%;border-collapse:collapse;font-size:12.5px}
th,td{border-bottom:1px dashed var(--border);padding:6px 6px;text-align:left;vertical-align:top}
th{color:#9fb0c6;text-transform:uppercase;letter-spacing:.06em;font-size:11px}
.right{text-align:right}
.bad{color:var(--bad)}.ok{color:var(--ok)}.warn{color:var(--warn)}
.badge{display:inline-block;padding:2px 6px;border-radius:8px;border:1px solid var(--border);background:#0d1a2a;font-size:11px}
.kv{display:grid;grid-template-columns:160px 1fr;gap:6px;align-items:center}
.tag{display:inline-block;border:1px solid var(--border);padding:2px 6px;border-radius:8px;background:#0d1a2a;margin-right:6px;font-size:11px}
input[type="number"]{width:120px}
.cell{display:flex;gap:6px;align-items:center}
a.action{color:#4fc3f7;cursor:pointer;text-decoration:underline}
</style>
</head>
<body>
<div class="wrap">
  <h1>‚ö° OMEGA LITE+ ‚Äî <span class="badge">Liquidity Map ‚Ä¢ Trap</span> <span class="badge">OCR Winrate (editable)</span></h1>

  <!-- CONTROL -->
  <div class="card">
    <div class="row">
      <label>C·∫∑p:</label>
      <select id="coinSel"><option>BTCUSDT</option><option>ETHUSDT</option><option>SOLUSDT</option><option>LINKUSDT</option><option>LTCUSDT</option><option>ETHFIUSDT</option></select>
      <label>Khung:</label>
      <select id="mainTF"><option>5m</option><option>15m</option><option>30m</option><option selected>1h</option><option>4h</option><option>1d</option></select>
      <button class="btn primary" id="runBtn">Ch·∫°y</button>
      <span id="status" class="small"></span>
    </div>
    <div class="small">T·∫≠p trung cho GPT: Snapshot ‚Üí Liquidity/Trap ‚Üí ·∫¢nh v·ªã th·∫ø & Winrate ‚Üí Copy Auto-Prompt.</div>
  </div>

  <!-- SNAPSHOT + LIQUIDITY -->
  <div class="card">
    <h2>üìà Snapshot & Liquidity Map</h2>
    <div id="chartBox" class="chart"></div>
    <div class="kv small" id="snapInfo"></div>
    <div class="divider"></div>
    <div id="liqMap"></div>
    <div id="trapBox" style="margin-top:8px;"></div>
    <div id="fadeRR" class="small" style="margin-top:8px;"></div>
  </div>

  <!-- OCR + WINRATE (Editable) -->
  <div class="card">
    <h2>üñºÔ∏è ·∫¢nh v·ªã th·∫ø ‚Üí OCR ‚Üí B·∫£ng ch·ªânh s·ª≠a & Winrate</h2>
    <div class="row">
      <input type="file" id="imgInput" accept="image/*" multiple />
      <button class="btn" id="addRow">Th√™m d√≤ng tr·ªëng</button>
      <button class="btn" id="clrTrades">Xo√° danh s√°ch</button>
      <button class="btn" id="expCSV">Xu·∫•t CSV</button>
    </div>
    <div id="ocrStatus" class="small"></div>
    <div id="tradeTable"></div>
    <div class="small" id="winStats"></div>
  </div>

  <!-- PROMPT -->
  <div class="card">
    <h2>ü§ñ Copy Auto-Prompt (VN)</h2>
    <div class="row">
      <button class="btn" id="copyPrompt">Copy Snapshot + Winrate (AI Prompt)</button>
      <span id="copyStatus" class="small"></span>
    </div>
  </div>
</div>

<script>
const API={k:(s,tf,lim=700)=>`https://api.binance.com/api/v3/klines?symbol=${s}&interval=${tf}&limit=${lim}`};
const dur={'5m':300,'15m':900,'30m':1800,'1h':3600,'4h':14400,'1d':86400};
function fmt(n,d=2){if(n==null||isNaN(n))return'‚Äî';return Number(n).toFixed(d)}
function lastClosedIdx(rows,tf){const now=Date.now()/1000;const d=dur[tf];let i=rows.length-1;if(now-rows[i].ts<0.5*d)i-=1;return i}
function sma(a,p){let o=[],s=0;for(let i=0;i<a.length;i++){s+=a[i];if(i>=p)s-=a[i-p];o.push(i>=p-1?s/p:NaN)}return o}
function ema(a,p){const k=2/(p+1);let o=[],pr=a[0];o.push(pr);for(let i=1;i<a.length;i++){const v=a[i]*k+pr*(1-k);o.push(v);pr=v}return o}
function rsi(c,p=14){let g=[],l=[];for(let i=1;i<c.length;i++){const d=c[i]-c[i-1];g.push(Math.max(0,d));l.push(Math.max(0,-d));}const ag=sma(g,p),al=sma(l,p);let o=[NaN];for(let i=0;i<ag.length;i++){if(i<p-1){o.push(NaN);continue;}const rs=(al[i]===0)?100:ag[i]/al[i];o.push(100-(100/(1+rs)))}return o}
function atr(h,l,c,p=14){let tr=[NaN];for(let i=1;i<c.length;i++){const pc=c[i-1];tr.push(Math.max(h[i]-l[i],Math.abs(h[i]-pc),Math.abs(l[i]-pc)))}return sma(tr,p)}
function bb(c,p=20,n=2){const ma=sma(c,p);let sd=[];for(let i=0;i<c.length;i++){if(i<p-1){sd.push(NaN);continue;}const w=c.slice(i-p+1,i+1);const m=ma[i];const v=w.reduce((a,v)=>a+Math.pow(v-m,2),0)/p;sd.push(Math.sqrt(v))}const up=ma.map((m,i)=>isNaN(m)||isNaN(sd[i])?NaN:m+n*sd[i]);const lo=ma.map((m,i)=>isNaN(m)||isNaN(sd[i])?NaN:m-n*sd[i]);const width=ma.map((m,i)=>isNaN(m)||m===0||isNaN(sd[i])?NaN:(up[i]-lo[i])/m);return {ma,up,lo,width}}
function macd(c,f=12,s=26,sig=9){const ef=ema(c,f),es=ema(c,s);const line=ef.map((v,i)=>v-es[i]);const sigA=ema(line.slice(s-1),sig);const sigF=Array(s-1).fill(NaN).concat(sigA);const hist=line.map((v,i)=>v-(sigF[i]??NaN));return {line,signal:sigF,hist}}

async function fetchK(sym,tf,lim=700){
  const r=await fetch(API.k(sym,tf,lim)); if(!r.ok) throw new Error('Klines l·ªói');
  const a=await r.json(); return a.map(x=>({ts:Math.floor(x[6]/1000),open:+x[1],high:+x[2],low:+x[3],close:+x[4],volume:+x[5]}));
}

// ===== Liquidity Map =====
function detectEqualHighLow(rows, look=50, tol=0.0008){
  const h=rows.map(r=>r.high), l=rows.map(r=>r.low);
  let ehi=[], elo=[];
  for(let i=Math.max(2,rows.length-look); i<rows.length-1; i++){
    // pivot high/low
    const ph = h[i-1]<h[i] && h[i+1]<h[i];
    const pl = l[i-1]>l[i] && l[i+1]>l[i];
    if(ph){
      // t√¨m ƒëi·ªÉm kh√°c c√≥ high g·∫ßn b·∫±ng trong c·ª≠a s·ªï
      for(let j=i-8;j<i+9;j++){
        if(j<=0||j>=h.length||j===i) continue;
        if(Math.abs(h[j]-h[i])/h[i] <= tol){ ehi.push({ts:rows[i].ts, price:h[i]}); break; }
      }
    }
    if(pl){
      for(let j=i-8;j<i+9;j++){
        if(j<=0||j>=l.length||j===i) continue;
        if(Math.abs(l[j]-l[i])/l[i] <= tol){ elo.push({ts:rows[i].ts, price:l[i]}); break; }
      }
    }
  }
  return {ehi, elo};
}
function detectFVG(rows, look=120){
  const out=[];
  for(let i=1;i<rows.length;i++){
    const prev=rows[i-1], cur=rows[i];
    // bullish FVG: low(current) > high(prev)
    if(cur.low>prev.high){ out.push({ts:cur.ts, type:'Bullish FVG', top:cur.low, bottom:prev.high}); }
    // bearish FVG: high(current) < low(prev)
    if(cur.high<prev.low){ out.push({ts:cur.ts, type:'Bearish FVG', top:prev.low, bottom:cur.high}); }
  }
  return out.slice(-look);
}
function detectSweeps(rows){
  const c=rows.map(r=>r.close), h=rows.map(r=>r.high), l=rows.map(r=>r.low);
  const a14=atr(h,l,c,14);
  const notes=[];
  for(let i=25;i<rows.length;i++){
    const atrv=a14[i]; if(!isFinite(atrv)) continue;
    const lb=10; const ph=Math.max(...h.slice(i-lb,i)); const pl=Math.min(...l.slice(i-lb,i));
    const range=h[i]-l[i];
    // buy-side sweep
    if(h[i]>ph && rows[i].close<rows[i].open && range>1.2*atrv){
      notes.push({ts:rows[i].ts, type:'Buy-side sweep', dir:'down', level:ph, wick:h[i]});
    }
    // sell-side sweep
    if(l[i]<pl && rows[i].close>rows[i].open && range>1.2*atrv){
      notes.push({ts:rows[i].ts, type:'Sell-side sweep', dir:'up', level:pl, wick:l[i]});
    }
  }
  return notes.slice(-6);
}
function rrFadeSweep(lastPrice, sweep, atr){
  if(!sweep||!isFinite(atr)) return null;
  // Entry: retest level (sweep.level)
  // SL: beyond wick by 0.5*ATR; TP: ƒë·∫øn v√πng ƒë·ªëi di·ªán = level +/- 1.5*ATR
  if(sweep.dir==='down'){ // short fade sau buy-side sweep
    const entry=sweep.level;
    const sl=sweep.wick + 0.5*atr;
    const tp=entry - 1.5*atr;
    const rr=(entry-tp)/(sl-entry);
    return {side:'Short (fade sweep)', entry, sl, tp, rr};
  }else{ // long fade sau sell-side sweep
    const entry=sweep.level;
    const sl=sweep.wick - 0.5*atr;
    const tp=entry + 1.5*atr;
    const rr=(tp-entry)/(entry-sl);
    return {side:'Long (fade sweep)', entry, sl, tp, rr};
  }
}

function renderLiqMap(el, rows){
  const {ehi, elo}=detectEqualHighLow(rows);
  const fvgs=detectFVG(rows);
  let html='<div class="small"><b>Liquidity Map</b> ‚Äî Equal High/Low & FVG g·∫ßn ƒë√¢y</div><table><thead><tr><th>Lo·∫°i</th><th>Th√¥ng tin</th></tr></thead><tbody>';
  if(!ehi.length && !elo.length && !fvgs.length){
    html+='<tr><td colspan="2">Ch∆∞a ph√°t hi·ªán c·ª•m thanh kho·∫£n/FVG n·ªïi b·∫≠t trong c·ª≠a s·ªï g·∫ßn ƒë√¢y.</td></tr>';
  }else{
    ehi.slice(-5).forEach(x=> html+=`<tr><td>EHI (Equal High)</td><td>Price‚âà<b>${fmt(x.price,2)}</b> ‚Ä¢ Th·ªùi ƒëi·ªÉm: ${new Date((x.ts+7*3600)*1000).toISOString().replace('T',' ').slice(0,16)}</td></tr>`);
    elo.slice(-5).forEach(x=> html+=`<tr><td>ELO (Equal Low)</td><td>Price‚âà<b>${fmt(x.price,2)}</b> ‚Ä¢ Th·ªùi ƒëi·ªÉm: ${new Date((x.ts+7*3600)*1000).toISOString().replace('T',' ').slice(0,16)}</td></tr>`);
    fvgs.slice(-6).forEach(x=> html+=`<tr><td>${x.type}</td><td>V√πng: <b>${fmt(x.bottom,2)} ‚Üí ${fmt(x.top,2)}</b> ‚Ä¢ ${new Date((x.ts+7*3600)*1000).toISOString().replace('T',' ').slice(0,16)}</td></tr>`);
  }
  html+='</tbody></table>';
  el.innerHTML=html;
}

// ===== Chart =====
function renderChart(el, rows){
  const chart=LightweightCharts.createChart(el,{layout:{background:{type:'solid',color:'#0f1824'},textColor:'#e7f0fb'},grid:{vertLines:{color:'#1c2940'},horzLines:{color:'#1c2940'}},timeScale:{timeVisible:true},rightPriceScale:{borderColor:'#263a57'}});
  const s=chart.addCandlestickSeries({upColor:'#00c853',downColor:'#ff5252',borderVisible:false,wickUpColor:'#00c853',wickDownColor:'#ff5252'});
  const data=rows.map(r=>({time:Math.floor(r.ts),open:r.open,high:r.high,low:r.low,close:r.close}));
  s.setData(data);
  return chart;
}

// ===== OCR + Editable trades =====
let trades = JSON.parse(localStorage.getItem('omega_lite_trades_plus')||'[]');
function saveTrades(){ localStorage.setItem('omega_lite_trades_plus', JSON.stringify(trades)); }

function renderTrades(){
  let html='<table><thead><tr><th>#</th><th>Th·ªùi gian</th><th>Side</th><th>Entry</th><th>SL</th><th>TP</th><th>Size</th><th>PNL</th><th>KQ</th><th>H√†nh ƒë·ªông</th></tr></thead><tbody>';
  trades.forEach((t,i)=>{
    html+=`<tr>
      <td>${i+1}</td>
      <td><input value="${t.time||''}" data-i="${i}" data-k="time"/></td>
      <td><select data-i="${i}" data-k="side"><option ${t.side==='Long'?'selected':''}>Long</option><option ${t.side==='Short'?'selected':''}>Short</option></select></td>
      <td><input type="number" step="0.0001" value="${t.entry||''}" data-i="${i}" data-k="entry"/></td>
      <td><input type="number" step="0.0001" value="${t.sl||''}" data-i="${i}" data-k="sl"/></td>
      <td><input type="number" step="0.0001" value="${t.tp||''}" data-i="${i}" data-k="tp"/></td>
      <td><input type="number" step="0.0001" value="${t.size||''}" data-i="${i}" data-k="size"/></td>
      <td><input value="${t.pnl||''}" data-i="${i}" data-k="pnl"/></td>
      <td>
        <select data-i="${i}" data-k="result">
          <option ${t.result==='WIN'?'selected':''}>WIN</option>
          <option ${t.result==='LOSS'?'selected':''}>LOSS</option>
        </select>
      </td>
      <td class="cell"><a class="action" data-act="del" data-i="${i}">xo√°</a></td>
    </tr>`;
  });
  html+='</tbody></table>';
  document.getElementById('tradeTable').innerHTML=html;
  // Bind inputs
  document.querySelectorAll('#tradeTable input, #tradeTable select').forEach(el=>{
    el.addEventListener('change', (e)=>{
      const i=+e.target.getAttribute('data-i'); const k=e.target.getAttribute('data-k'); trades[i][k]=e.target.value; computeStats(); saveTrades();
    });
  });
  document.querySelectorAll('#tradeTable a[data-act="del"]').forEach(a=>{
    a.addEventListener('click', (e)=>{
      const i=+e.target.getAttribute('data-i'); trades.splice(i,1); renderTrades(); computeStats(); saveTrades();
    });
  });
  computeStats();
}
function num(x){const v=parseFloat(String(x).replace(/[^0-9\.\-]/g,'')); return isFinite(v)?v:null}
function computeStats(){
  const wins=trades.filter(t=>t.result==='WIN'); const loss=trades.filter(t=>t.result==='LOSS');
  const wr = trades.length? (wins.length/trades.length*100):0;
  const avgW = wins.length? (wins.map(t=>num(t.pnl)||0).reduce((a,b)=>a+b,0)/wins.length):0;
  const avgL = loss.length? (loss.map(t=>num(t.pnl)||0).reduce((a,b)=>a+b,0)/loss.length):0;
  const expt = (wr/100)*avgW + (1-wr/100)*avgL;
  document.getElementById('winStats').innerHTML=`T·ªïng: <b>${trades.length}</b> ‚Ä¢ Win: <b>${wins.length}</b> ‚Ä¢ Loss: <b>${loss.length}</b> ‚Ä¢ Winrate: <b>${wr.toFixed(1)}%</b> ‚Ä¢ AvgWin: <b>${avgW.toFixed(2)}</b> ‚Ä¢ AvgLoss: <b>${avgL.toFixed(2)}</b> ‚Ä¢ Expectancy: <b>${expt.toFixed(2)}</b>`;
}

async function ocrImage(file){
  document.getElementById('ocrStatus').textContent='ƒêang nh·∫≠n d·∫°ng...';
  const worker = await Tesseract.createWorker('eng'); // n·∫øu mu·ªën h·ªó tr·ª£ vie, c·∫ßn th√™m traineddata
  const { data:{ text } } = await worker.recognize(file);
  await worker.terminate();
  const clean=text.replace(/\s+/g,' ').trim();
  function find(re){const m=clean.match(re); return m?m[1]:null}
  const entry = find(/Entry(?:\s*Price)?[:\s]*([0-9]+(?:\.[0-9]+)?)/i);
  const sl    = find(/SL|Stop(?:\s*Loss)?[:\s]*([0-9]+(?:\.[0-9]+)?)/i);
  const tp    = find(/TP|Take(?:\s*Profit)?[:\s]*([0-9]+(?:\.[0-9]+)?)/i);
  const size  = find(/Size|Qty[:\s]*([0-9]+(?:\.[0-9]+)?)/i);
  const side  = (clean.match(/Long/i)?'Long':(clean.match(/Short/i)?'Short':'Long'));
  const pnlM  = clean.match(/PNL|Profit[:\s]*([+\-]?\$?\s*[0-9]+(?:\.[0-9]+)?)/i);
  const pnl   = pnlM? pnlM[1]: null;
  const result = (pnl && pnl.replace(/[^0-9\.\-]/g,'')!=='') ? (parseFloat(pnl.replace(/[^0-9\.\-]/g,''))>=0?'WIN':'LOSS') : 'WIN';
  trades.push({time:new Date().toLocaleString('vi-VN'), side, entry, sl, tp, size, pnl, result});
  renderTrades(); saveTrades();
  document.getElementById('ocrStatus').textContent='ƒê√£ th√™m 1 v·ªã th·∫ø.';
}

function exportCSV(){
  let csv="time,side,entry,sl,tp,size,pnl,result\n";
  trades.forEach(t=>{csv+=`${t.time||''},${t.side||''},${t.entry||''},${t.sl||''},${t.tp||''},${t.size||''},${t.pnl||''},${t.result||''}\n`;});
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='omega_trades.csv'; a.click();
}

// ===== Run & Prompt =====
function buildPrompt(sym, tf, liqTxt, trapTxt, rrTxt, statsTxt, tableTxt){
  return `# SNAPSHOT LITE+ ‚Äî ${new Date().toLocaleString('vi-VN')}
- Symbol: ${sym} ‚Ä¢ TF: ${tf}
- Liquidity Map: 
${liqTxt||'(ch∆∞a c√≥ ƒëi·ªÉm n·ªïi b·∫≠t)'}
- Trap/Sweep g·∫ßn ƒë√¢y:
${trapTxt||'(kh√¥ng th·∫•y trap r√µ)'}
- ∆Ø·ªõc l∆∞·ª£ng setup "fade sweep":
${rrTxt||'(ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán)'}

- Winrate c√° nh√¢n (t·ª´ ·∫£nh v·ªã th·∫ø):
${statsTxt}
Chi ti·∫øt:
${tableTxt}

# PROMPT
H√£y ƒë·ªçc Liquidity/Trap, ∆∞u ti√™n fade sweep n·∫øu h·ª£p l·ªá; ƒëi·ªÅu ch·ªânh Entry/SL/TP theo c·∫•u tr√∫c g·∫ßn nh·∫•t v√† ATR. 
N·∫øu t√¥i c√≥ Spot, xem c√≥ n√™n hedge kh√¥ng (t·ª∑ l·ªá %). 
K·∫øt lu·∫≠n: Long/Short/Neutral, checklist r·ªßi ro, v√† ƒëi·ªÉm t·ª± tin (%).`;
}

async function run(){
  const sym=document.getElementById('coinSel').value;
  const tf=document.getElementById('mainTF').value;
  const st=document.getElementById('status'); st.textContent='ƒêang t·∫£i...';
  try{
    const rows=await fetchK(sym, tf, 700);
    const i=lastClosedIdx(rows, tf); const cut=rows.slice(0,i+1);
    document.getElementById('chartBox').innerHTML='';
    renderChart(document.getElementById('chartBox'), cut);
    // Snapshot info
    const c=cut.map(r=>r.close), h=cut.map(r=>r.high), l=cut.map(r=>r.low);
    const ema20=ema(c,20), rsi14=rsi(c,14), a14=atr(h,l,c,14);
    document.getElementById('snapInfo').innerHTML=`<span>Gi√°: <b>${fmt(c[c.length-1])}</b></span><span>EMA20: <b>${fmt(ema20[ema20.length-1])}</b></span><span>RSI14: <b>${fmt(rsi14[rsi14.length-1])}</b></span><span>ATR14: <b>${fmt(a14[a14.length-1])}</b></span><span>N·∫øn: ${tf}</span>`;
    // Liquidity map & trap
    renderLiqMap(document.getElementById('liqMap'), cut);
    const sweeps=detectSweeps(cut);
    let trapHTML='<table><thead><tr><th>Th·ªùi ƒëi·ªÉm</th><th>Lo·∫°i</th><th>M·ª©c qu√©t</th><th>R√¢u</th></tr></thead><tbody>';
    if(sweeps.length){
      sweeps.forEach(s=> trapHTML+=`<tr><td>${new Date((s.ts+7*3600)*1000).toISOString().replace('T',' ').slice(0,16)}</td><td>${s.type}</td><td>${fmt(s.level,2)}</td><td>${fmt(s.wick,2)}</td></tr>`);
    }else{
      trapHTML+='<tr><td colspan="4">Ch∆∞a th·∫•y sweep ƒë·ªß m·∫°nh trong c·ª≠a s·ªï g·∫ßn ƒë√¢y.</td></tr>';
    }
    trapHTML+='</tbody></table>';
    document.getElementById('trapBox').innerHTML=trapHTML;
    // RR fade
    const rr=rrFadeSweep(c[c.length-1], sweeps[sweeps.length-1], a14[a14.length-1]);
    document.getElementById('fadeRR').innerHTML = rr? `ƒê·ªÅ xu·∫•t: <b>${rr.side}</b> ‚Ä¢ Entry‚âà<b>${fmt(rr.entry)}</b> ‚Ä¢ SL‚âà<b>${fmt(rr.sl)}</b> ‚Ä¢ TP‚âà<b>${fmt(rr.tp)}</b> ‚Ä¢ R:R‚âà<b>${fmt(rr.rr,2)}</b>` : 'Ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán ∆∞·ªõc l∆∞·ª£ng fade sweep.';
    st.textContent='Xong.';
  }catch(e){ st.textContent='L·ªói t·∫£i d·ªØ li·ªáu.' }
}

function copyPrompt(){
  const sym=document.getElementById('coinSel').value;
  const tf=document.getElementById('mainTF').value;
  const liq=document.getElementById('liqMap').innerText.trim();
  const trap=document.getElementById('trapBox').innerText.trim();
  const rr=document.getElementById('fadeRR').innerText.trim();
  const stats=document.getElementById('winStats').innerText.trim();
  const table=document.getElementById('tradeTable').innerText.trim();
  const md=buildPrompt(sym, tf, liq, trap, rr, stats, table);
  navigator.clipboard.writeText(md).then(()=>{document.getElementById('copyStatus').textContent='ƒê√£ copy Auto-Prompt.'});
}

// Bind
document.getElementById('runBtn').addEventListener('click', run);
document.getElementById('copyPrompt').addEventListener('click', copyPrompt);
document.getElementById('imgInput').addEventListener('change', (e)=>{[...e.target.files].forEach(f=>ocrImage(f))});
document.getElementById('addRow').addEventListener('click', ()=>{trades.push({time:new Date().toLocaleString('vi-VN'), side:'Long', entry:'', sl:'', tp:'', size:'', pnl:'', result:'WIN'}); renderTrades(); saveTrades();});
document.getElementById('clrTrades').addEventListener('click', ()=>{trades=[]; renderTrades(); saveTrades();});
document.getElementById('expCSV').addEventListener('click', exportCSV);

// Init
renderTrades();
</script>
</body>
</html>
